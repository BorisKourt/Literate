#!/usr/bin/env julia

function name(path)
    basename(path[1:search(path, '.')[1]-1])
end

html = false
code = false
outdir = "."

inputfiles = String[]

for arg in ARGS
    if arg == "-h"
        println("Usage: lit [-html] [-code] [file ...]")
        exit()
    elseif arg == "-html"
        html = true
    elseif arg == "-code"
        code = true
    elseif startswith(arg, "--out-dir=")
        outdir = realpath(arg[11:end])
    else
        push!(inputfiles, arg)
    end
end

if !html && !code
    html = code = true
end

gen = "$(dirname(Base.source_path()))/../gen"

if length(inputfiles) == 0
input = readall(STDIN)
if html
    include("$gen/weave.jl")
    weave(readlines(IOBuffer(input), STDOUT))
end

if code
    include("$gen/tangle.jl")
    tangle(readlines(IOBuffer(input)))
end

else
if code
    include("$gen/tangle.jl")
end
if html
    include("$gen/weave.jl")
end

for file in inputfiles
    inputstream = open(file)
    input = readall(inputstream)
    close(inputstream)
    source_dir = dirname(file) == "" ? "." : dirname(file)
    if html
        outputstream = open("$outdir/$(name(file)).html", "w")
        weave(readlines(IOBuffer(input)), outputstream, source_dir)
        close(outputstream)
    end
    if code
        tangle(readlines(IOBuffer(input)))
    end
end

end

# vim: set ft=julia:

